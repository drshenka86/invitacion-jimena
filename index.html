<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Confirmaciones de Asistencia â€” Julianchis y ElÃ­as FEST</title>

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&family=Parisienne&display=swap" rel="stylesheet">

  <style>
    :root{
      --color-primario: #000000;
      --color-secundario: #ffce00;
      --color-fondo: #0d0d0d;
      --color-texto: #f1f1f1;
      --color-texto-claro: #c9c9c9;
      --color-borde: #2a2a2a;
      --color-sombra: rgba(255,206,0,0.12);
      --color-boton: #ffce00;
      --color-boton-hover: #e0b800;
      --card-bg: #0d0d0d;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Montserrat',sans-serif;background:radial-gradient(circle at top left,#1a1a1a 0%,#000 100%);color:var(--color-texto);min-height:100vh;padding-bottom:40px}
    .container{max-width:1000px;margin:22px auto;padding:18px}
    header.app-header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    .logo-img{width:72px;height:72px;object-fit:cover;border-radius:10px;border:2px solid var(--color-secundario);box-shadow:0 6px 18px var(--color-sombra)}
    h1{font-size:20px;margin:0;color:var(--color-secundario);font-weight:600}
    .controls{display:flex;gap:10px;margin:14px 0;flex-wrap:wrap;align-items:center}
    .search{flex:1;min-width:180px;background:var(--card-bg);border:1px solid var(--color-borde);padding:10px 12px;border-radius:12px;color:var(--color-texto)}
    .btn{background:var(--color-boton);color:#000;border:none;padding:10px 14px;border-radius:999px;font-weight:600;cursor:pointer;box-shadow:0 6px 14px var(--color-sombra);text-transform:uppercase;letter-spacing:0.6px}
    .btn:hover{background:var(--color-boton-hover);transform:scale(1.02)}
    .stats{display:flex;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .stat-card{background:var(--card-bg);border-radius:12px;padding:14px;box-shadow:0 6px 18px var(--color-sombra);border:1px solid var(--color-borde);min-width:140px;flex:1}
    .stat-title{font-size:13px;color:var(--color-texto-claro);margin:0 0 6px 0}
    .stat-value{font-size:20px;color:var(--color-secundario);font-weight:700}
    .list-card{background:var(--card-bg);border-radius:12px;overflow:hidden;border:1px solid var(--color-borde);box-shadow:0 6px 18px var(--color-sombra)}
    .list-header{background:linear-gradient(90deg,rgba(0,0,0,0.45),rgba(26,26,26,0.6));color:var(--color-secundario);padding:12px 16px;font-weight:700;letter-spacing:0.6px}
    #confirmacionesList{padding:12px;display:flex;flex-direction:column;gap:10px;max-height:60vh;overflow:auto}
    .confirm-item{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(255,255,255,0.00));border:1px solid transparent}
    .avatar{width:56px;height:56px;border-radius:10px;background:linear-gradient(180deg,#111,#0d0d0d);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--color-secundario);border:2px solid rgba(255,206,0,0.12);flex-shrink:0}
    .info{flex:1;min-width:0}
    .name{font-size:16px;font-weight:600;color:var(--color-texto);margin-bottom:4px}
    .meta{font-size:13px;color:var(--color-texto-claro);line-height:1.2}
    .right{text-align:right;min-width:120px}
    .right .people{font-weight:700;color:var(--color-secundario);font-size:16px}
    .empty{padding:20px;text-align:center;color:var(--color-texto-claro);font-style:italic}
    .loading{padding:18px;text-align:center;color:var(--color-texto-claro);font-style:italic}
    .pagination{display:flex;gap:8px;align-items:center;margin-top:12px;justify-content:center}
    .page-info{color:var(--color-texto-claro);font-size:13px}
    .small-btn{padding:6px 10px;border-radius:8px;background:transparent;border:1px solid var(--color-borde);color:var(--color-texto);cursor:pointer}
    .toggle-dark{background:transparent;border:1px solid var(--color-borde);color:var(--color-texto);padding:8px 10px;border-radius:10px;cursor:pointer}
    footer{text-align:center;margin-top:18px;color:var(--color-texto-claro);font-size:13px}
    @media(max-width:640px){.right{min-width:90px;font-size:13px}.avatar{width:48px;height:48px}}
  </style>
</head>
<body>
  <div class="container">
    <header class="app-header" role="banner">
      <img class="logo-img" src="https://i.ibb.co/wFVHyPtL/04476d50-b059-4919-b8dc-81ac6d097f40.jpg" alt="Logo evento" />
      <div>
        <h1>Confirmaciones â€” Julianchis y ElÃ­as FEST</h1>
        <div style="font-size:13px;color:var(--color-texto-claro)">Panel paginado â€” Carga por pÃ¡ginas</div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button class="toggle-dark" id="toggleTheme" title="Cambiar tema">ðŸŒ—</button>
      </div>
    </header>

    <section class="controls" aria-label="Controles">
      <input id="searchInput" class="search" type="text" placeholder="Buscar por nombre..." aria-label="Buscar por nombre" />
      <button class="btn" id="exportCsvBtn">Exportar CSV</button>
      <button class="btn" id="refreshBtn" style="background:transparent;color:var(--color-texto);border:1px solid var(--color-borde);box-shadow:none">Actualizar</button>
    </section>

    <section class="stats">
      <div class="stat-card">
        <div class="stat-title">Total Confirmaciones</div>
        <div class="stat-value" id="totalConfirmaciones">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-title">Adultos Totales</div>
        <div class="stat-value" id="totalAdultos">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">NiÃ±os Totales</div>
        <div class="stat-value" id="totalNinos">0</div>
      </div>

      <div class="stat-card">
        <div class="stat-title">Total Personas</div>
        <div class="stat-value" id="totalPersonas">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">Ãšltima actualizaciÃ³n</div>
        <div class="stat-value" id="lastUpdate">â€”</div>
      </div>
    </section>

    <section class="list-card" aria-labelledby="listTitle">
      <div class="list-header" id="listTitle">Lista de Confirmaciones</div>

      <div id="confirmationsArea">
        <div id="loading" class="loading">Cargando datos...</div>
        <div id="confirmacionesList" aria-live="polite" role="list"></div>

        <!-- Controles de paginaciÃ³n -->
        <div class="pagination" aria-label="PaginaciÃ³n">
          <button id="prevPage" class="small-btn" disabled>Anterior</button>
          <div class="page-info">PÃ¡gina <span id="pageNumber">1</span></div>
          <button id="nextPage" class="small-btn" disabled>Siguiente</button>
        </div>
      </div>
    </section>

    <footer>
      VersiÃ³n <strong>1.0.10</strong> â€” <time id="fechaPublicacion"></time>
    </footer>
  </div>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAG1fFh_ZwN4hSYe-1v-yxqsW4WWjyjkl4",
      authDomain: "confirmaciones-jimena.firebaseapp.com",
      projectId: "confirmaciones-jimena",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // PaginaciÃ³n
    const pageSize = 10;            // items por pÃ¡gina
    let currentPage = 1;
    let firstDoc = null;
    let lastDoc = null;
    let allCountCache = null;       // opcional: cache del total (si quieres)
    let currentItems = [];          // elementos de la pÃ¡gina actual

    let datosOriginales = []; // usado por bÃºsqueda si decides cargar todo (no usado para paginaciÃ³n por defecto)

    // Utiles
    function calcularDetalle(doc) {
      const adultos = Number(doc.adultos ?? doc.adults ?? 0);
      const ninos = Number(doc.ninos ?? doc.children ?? 0);
      return { adultos, ninos, total: adultos + ninos };
    }
    function formatFechaHora(timestamp) {
      if (!timestamp) return 'Sin fecha';
      try {
        const d = (timestamp.toDate) ? timestamp.toDate() : new Date(timestamp);
        return d.toLocaleString('es-MX', { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      } catch(e) { return 'â€”'; }
    }

    // Render de la pÃ¡gina actual
    function renderPage(items) {
      const listEl = document.getElementById('confirmacionesList');
      const loadingEl = document.getElementById('loading');
      listEl.innerHTML = '';

      if (!items.length) {
        loadingEl.style.display = 'none';
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = 'No hay confirmaciones en esta pÃ¡gina.';
        listEl.appendChild(empty);
        updateStats([], null);
        return;
      }
      loadingEl.style.display = 'none';

      // stats locales
      updateStats(items);

      items.forEach(d => {
        const det = calcularDetalle(d);
        const item = document.createElement('div');
        item.className = 'confirm-item';
        item.setAttribute('role','listitem');

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        const initials = (d.nombre || 'U').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
        avatar.textContent = initials;

        const info = document.createElement('div');
        info.className = 'info';
        const name = document.createElement('div');
        name.className = 'name';
        name.textContent = d.nombre || 'Sin nombre';
        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.innerHTML = `Adultos: <strong>${det.adultos}</strong> &nbsp; â€¢ &nbsp; NiÃ±os: <strong>${det.ninos}</strong><br>
                          <span style="color:var(--color-texto-claro)">${formatFechaHora(d.timestamp)}</span>`;
        const right = document.createElement('div');
        right.className = 'right';
        right.innerHTML = `<div class="people">${det.total}</div><div style="font-size:12px;color:var(--color-texto-claro)">Total</div>`;

        info.appendChild(name);
        info.appendChild(meta);
        item.appendChild(avatar);
        item.appendChild(info);
        item.appendChild(right);
        listEl.appendChild(item);
      });
    }

    // Actualiza estadÃ­sticas globales de la pÃ¡gina (y Ãºltima actualizaciÃ³n)
    function updateStats(pageItems = [], lastTimestamp = null) {
      // Calcula solo con los items de la pÃ¡gina actual
      let totalConfirm = pageItems.length;
      let totalPersonas = 0, totalAdultos = 0, totalNinos = 0;
      let latest = lastTimestamp;

      pageItems.forEach(d => {
        const det = calcularDetalle(d);
        totalPersonas += det.total;
        totalAdultos += det.adultos;
        totalNinos += det.ninos;
        if (d.timestamp && d.timestamp.toDate) {
          const t = d.timestamp.toDate();
          if (!latest || t > latest) latest = t;
        }
      });

      document.getElementById('totalConfirmaciones').textContent = totalConfirm;
      document.getElementById('totalPersonas').textContent = totalPersonas;
      document.getElementById('totalAdultos').textContent = totalAdultos;
      document.getElementById('totalNinos').textContent = totalNinos;
      document.getElementById('lastUpdate').textContent = latest ? latest.toLocaleString('es-MX', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' }) : 'â€”';
    }

    // Consultas paginadas
    async function loadFirstPage() {
      currentPage = 1;
      document.getElementById('pageNumber').textContent = currentPage;
      const q = db.collection('confirmaciones').orderBy('timestamp','desc').limit(pageSize);
      const snap = await q.get();
      const docs = snap.docs.map(d => d.data());
      firstDoc = snap.docs[0] || null;
      lastDoc = snap.docs[snap.docs.length - 1] || null;
      currentItems = docs;
      renderPage(docs);
      updatePaginationButtons(snap.docs.length === pageSize, false);
    }

    async function loadNextPage() {
      if (!lastDoc) return;
      const q = db.collection('confirmaciones').orderBy('timestamp','desc').startAfter(lastDoc).limit(pageSize);
      const snap = await q.get();
      const docs = snap.docs.map(d => d.data());
      if (!docs.length) return; // no hay mÃ¡s
      firstDoc = snap.docs[0] || null;
      lastDoc = snap.docs[snap.docs.length - 1] || null;
      currentPage++;
      document.getElementById('pageNumber').textContent = currentPage;
      currentItems = docs;
      renderPage(docs);
      updatePaginationButtons(snap.docs.length === pageSize, true);
    }

    async function loadPrevPage() {
      if (!firstDoc) return;
      // endBefore + limitToLast para pÃ¡gina anterior
      const q = db.collection('confirmaciones').orderBy('timestamp','desc').endBefore(firstDoc).limitToLast(pageSize);
      const snap = await q.get();
      const docs = snap.docs.map(d => d.data());
      if (!docs.length) return; // ya en inicio
      firstDoc = snap.docs[0] || null;
      lastDoc = snap.docs[snap.docs.length - 1] || null;
      currentPage = Math.max(1, currentPage - 1);
      document.getElementById('pageNumber').textContent = currentPage;
      currentItems = docs;
      renderPage(docs);
      // habilita/deshabilita botones segÃºn tamaÃ±o
      updatePaginationButtons(true, true);
      // Si ahora estamos en la primera pÃ¡gina, desactivar prev:
      if (!firstDoc) document.getElementById('prevPage').disabled = true;
    }

    function updatePaginationButtons(hasNext, hasPrev) {
      document.getElementById('nextPage').disabled = !hasNext;
      document.getElementById('prevPage').disabled = !hasPrev && currentPage === 1;
    }

    // Export CSV: exporta TODOS los registros (consulta completa)
    async function exportAllCSV() {
      const snap = await db.collection('confirmaciones').orderBy('timestamp','desc').get();
      const rows = snap.docs.map(d => {
        const data = d.data();
        const det = calcularDetalle(data);
        const nombre = `"${(data.nombre || '').replace(/"/g,'""')}"`;
        const fecha = formatFechaHora(data.timestamp).replace(/"/g,'""');
        return [nombre, det.adultos, det.ninos, det.total, `"${fecha}"`].join(',');
      });
      const header = ['Nombre','Adultos','NiÃ±os','Total','FechaHora'];
      const csv = [header.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'confirmaciones_todas.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // BÃºsqueda local: por simplicidad busca en la pÃ¡gina actual (si quieres bÃºsqueda global, hay que consultar todo)
    function searchInCurrentPage(q) {
      if (!q) { renderPage(currentItems); return; }
      const filtered = currentItems.filter(d => (d.nombre || '').toLowerCase().includes(q));
      renderPage(filtered);
    }

    // Eventos y arranque
    document.addEventListener('DOMContentLoaded', () => {
      // controles
      document.getElementById('nextPage').addEventListener('click', async () => {
        // deshabilita botÃ³n mientras carga
        document.getElementById('nextPage').disabled = true;
        await loadNextPage();
      });
      document.getElementById('prevPage').addEventListener('click', async () => {
        document.getElementById('prevPage').disabled = true;
        await loadPrevPage();
      });
      document.getElementById('refreshBtn').addEventListener('click', () => {
        // recarga la pÃ¡gina actual: si currentPage==1 llama loadFirstPage, else intenta reloadRelative
        if (currentPage === 1) loadFirstPage();
        else {
          // simple: volver a la primera y luego avanzar (coste pequeÃ±o). Alternativa: almacenar stack de cursors.
          // AquÃ­ hago mÃ©todo simple: volver a la primera y avanzar (asegura consistencia).
          (async () => {
            await loadFirstPage();
            for (let i = 1; i < currentPage; i++) {
              await loadNextPage();
            }
          })();
        }
      });
      document.getElementById('exportCsvBtn').addEventListener('click', exportAllCSV);
      document.getElementById('searchInput').addEventListener('input', (e) => {
        const q = e.target.value.trim().toLowerCase();
        searchInCurrentPage(q);
      });
      document.getElementById('toggleTheme').addEventListener('click', () => document.body.classList.toggle('light'));

      // footer fecha publicaciÃ³n
      const fechaEl = document.getElementById('fechaPublicacion');
      fechaEl.textContent = new Date().toLocaleString('es-MX', { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });

      // cargar primera pÃ¡gina
      loadFirstPage().catch(err => {
        document.getElementById('loading').textContent = 'Error al cargar datos: ' + (err.message || err);
      });
    });

    // cleanup
    window.addEventListener('beforeunload', () => {
      // no hay listeners persistentes en esta implementaciÃ³n paginada
    });
  </script>
</body>
</html>
